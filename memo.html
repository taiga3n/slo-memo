<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>スロ速メモ</title>
<meta name="theme-color" content="#0b0b0f" />
<style>
:root{
  --bg:#0b0b0f; --card:#151520; --ink:#f2f2f7; --muted:#a7a7b3;
  --line:#2a2a36; --acc:#4da3ff; --bad:#ff5c5c; --btn:#1e1e2a;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
  padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 4px}
h1{margin:0;font-size:20px}
.tab{padding:10px 14px;border-radius:16px;border:1px solid var(--line);background:transparent;color:var(--ink)}
.tab.active{background:var(--btn);border-color:transparent}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:18px;padding:14px;margin-bottom:12px
}
label{font-size:12px;color:var(--muted);margin:14px 0 8px;display:block}
input,textarea{
  width:100%;padding:14px;border-radius:16px;
  border:1px solid var(--line);background:#0f0f16;color:var(--ink);font-size:17px
}
textarea{min-height:80px}
.stack{display:flex;flex-direction:column;gap:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
button{
  padding:12px 14px;border-radius:16px;
  border:1px solid var(--line);background:var(--btn);color:var(--ink)
}
.primary{background:var(--acc);border-color:transparent;color:#001427;font-weight:800}
.danger{background:transparent;border-color:var(--bad);color:var(--bad)}
.actions{display:flex;flex-direction:column;gap:12px;margin-top:12px}
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(env(safe-area-inset-bottom)+16px);
  background:#0f0f16;border:1px solid var(--line);
  padding:10px 14px;border-radius:999px;font-size:13px;
  opacity:0;transition:.2s
}
.toast.show{opacity:1}
.items{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{border:1px solid var(--line);border-radius:16px;padding:12px;background:#0f0f16;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<header>
  <h1>スロ速メモ</h1>
  <div>
    <button id="tabAdd" class="tab active" type="button">追加</button>
    <button id="tabList" class="tab" type="button">履歴</button>
  </div>
</header>

<section id="add" class="card">
  <div class="stack">
    <div>
      <label>日付</label>
      <div class="row">
        <button id="today" type="button">今日</button>
        <button id="yesterday" type="button">昨日</button>
      </div>
      <input id="date" type="date" />
    </div>

    <div>
      <label>台番</label>
      <div class="row">
        <button id="daiMinus" type="button">-1</button>
        <button id="daiPlus" type="button">+1</button>
      </div>
      <input id="dai" inputmode="numeric" pattern="[0-9]*" placeholder="1141" />
    </div>

    <div>
      <label>当該ゲーム数（G）</label>
      <input id="games" inputmode="numeric" pattern="[0-9]*" placeholder="15178" />
    </div>

    <div>
      <label>スルー回数</label>
      <div class="row">
        <button id="suruMinus" type="button">-1</button>
        <button id="suruPlus" type="button">+1</button>
        <button id="suruZero" type="button">0</button>
      </div>
      <input id="suru" inputmode="numeric" pattern="[0-9]*" placeholder="3" />
    </div>

    <div>
      <label>メモ</label>
      <textarea id="memo" placeholder="有利切れっぽい…"></textarea>
    </div>
  </div>

  <div class="actions">
    <button id="save" class="primary" type="button">保存（最速）</button>
    <button id="saveNext" type="button">保存して次（台番+1）</button>
    <button id="reset" class="danger" type="button">入力リセット</button>
  </div>
</section>

<section id="list" class="card" style="display:none">
  <button id="copy" type="button">表示中をコピー</button>
  <div class="small">※ そのままLINEやメモに貼れます</div>
  <div id="items" class="items"></div>
</section>

<div id="toast" class="toast"></div>

<script>
(() => {
  "use strict";

  const LS = "slo_memo_v3"; // ここは変えない（既存データ維持）
  const $ = (id) => document.getElementById(id);

  const addSec = $("add");
  const listSec = $("list");
  const tabAdd = $("tabAdd");
  const tabList = $("tabList");
  const toast = $("toast");

  const dateEl = $("date");
  const daiEl = $("dai");
  const gamesEl = $("games");
  const suruEl = $("suru");
  const memoEl = $("memo");
  const itemsEl = $("items");

  const buzz = (ms=20) => { try { if (navigator.vibrate) navigator.vibrate(ms); } catch {} };
  const show = (t) => {
    toast.textContent = t;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1200);
  };

  // ローカル日付（iPhoneで日付ズレしない）
  const isoLocal = (d=new Date()) => {
    const x = new Date(d);
    x.setMinutes(x.getMinutes() - x.getTimezoneOffset());
    return x.toISOString().slice(0,10);
  };
  const today = () => isoLocal(new Date());
  const yesterday = () => {
    const d = new Date();
    d.setDate(d.getDate() - 1);
    return isoLocal(d);
  };

  const load = () => {
    try {
      const raw = localStorage.getItem(LS);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  const saveAll = (arr) => {
    // iPhoneでlocalStorageが詰まってても落ちないように
    try {
      localStorage.setItem(LS, JSON.stringify(arr));
      return true;
    } catch (e) {
      show("保存できない（容量/設定）");
      return false;
    }
  };

  const toNumOrNull = (v) => {
    const s = String(v ?? "").trim().replace(/[, ]/g, "");
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  };

  const render = () => {
    const data = load();
    itemsEl.innerHTML = "";
    if (!data.length) {
      const e = document.createElement("div");
      e.className = "small";
      e.style.marginTop = "10px";
      e.textContent = "データがありません。";
      itemsEl.appendChild(e);
      return;
    }
    for (const r of data) {
      const line = `${r.date} 台${r.dai} ${r.games}G スルー${r.suru}${r.memo ? " " + r.memo : ""}`;
      const el = document.createElement("div");
      el.className = "item";
      el.textContent = line;
      itemsEl.appendChild(el);
    }
  };

  const openAdd = () => {
    addSec.style.display = "";
    listSec.style.display = "none";
    tabAdd.classList.add("active");
    tabList.classList.remove("active");
  };

  const openList = () => {
    render();
    addSec.style.display = "none";
    listSec.style.display = "";
    tabList.classList.add("active");
    tabAdd.classList.remove("active");
  };

  tabAdd.addEventListener("click", openAdd);
  tabList.addEventListener("click", openList);

  $("today").addEventListener("click", () => { dateEl.value = today(); });
  $("yesterday").addEventListener("click", () => { dateEl.value = yesterday(); });

  $("daiMinus").addEventListener("click", () => {
    const n = toNumOrNull(daiEl.value);
    if (n == null) return;
    daiEl.value = String(n - 1);
    buzz(10);
  });
  $("daiPlus").addEventListener("click", () => {
    const n = toNumOrNull(daiEl.value);
    if (n == null) return;
    daiEl.value = String(n + 1);
    buzz(10);
  });

  $("suruMinus").addEventListener("click", () => {
    const n = toNumOrNull(suruEl.value) ?? 0;
    suruEl.value = String(Math.max(0, n - 1));
    buzz(10);
  });
  $("suruPlus").addEventListener("click", () => {
    const n = toNumOrNull(suruEl.value) ?? 0;
    suruEl.value = String(n + 1);
    buzz(10);
  });
  $("suruZero").addEventListener("click", () => {
    suruEl.value = "0";
    buzz(10);
  });

  const save = (next) => {
    const dai = toNumOrNull(daiEl.value);
    const games = toNumOrNull(gamesEl.value);
    const suru = toNumOrNull(suruEl.value) ?? 0;

    if (dai == null || games == null) {
      show("未入力あり");
      buzz(25);
      return;
    }

    const r = {
      date: dateEl.value || yesterday(),
      dai: String(dai),
      games: String(games),
      suru: String(suru),
      memo: memoEl.value.trim()
    };

    const data = load();
    data.unshift(r);

    if (!saveAll(data)) return;

    show("保存した");
    buzz(20);

    gamesEl.value = "";
    suruEl.value = "";
    memoEl.value = "";

    if (next) daiEl.value = String(dai + 1);

    daiEl.focus();
  };

  $("save").addEventListener("click", () => save(false));
  $("saveNext").addEventListener("click", () => save(true));

  $("reset").addEventListener("click", () => {
    gamesEl.value = "";
    suruEl.value = "";
    memoEl.value = "";
    show("リセット");
    buzz(15);
  });

  $("copy").addEventListener("click", async () => {
    const lines = load().map(r =>
      `${r.date} 台${r.dai} ${r.games}G スルー${r.suru}${r.memo ? " " + r.memo : ""}`
    ).join("\n");

    // まずはClipboard API
    try {
      await navigator.clipboard.writeText(lines);
      show("コピーした");
      buzz(20);
      return;
    } catch {}

    // フォールバック（iOSで効くことが多い）
    try {
      const ta = document.createElement("textarea");
      ta.value = lines;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      if (ok) {
        show("コピーした");
        buzz(20);
      } else {
        alert(lines);
      }
    } catch {
      alert(lines);
    }
  });

  // 初期：昨日、台番フォーカス
  dateEl.value = yesterday();
  setTimeout(() => daiEl.focus(), 200);
})();
</script>
</body>
</html>
