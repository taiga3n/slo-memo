<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>スロ速メモ</title>
<meta name="theme-color" content="#0b0b0f" />
<style>
:root{
  --bg:#0b0b0f; --card:#151520; --ink:#f2f2f7; --muted:#a7a7b3;
  --line:#2a2a36; --acc:#4da3ff; --bad:#ff5c5c; --btn:#1e1e2a;
}
*{box-sizing:border-box}
body{
  margin:0; background:var(--bg); color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;
  padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
}
header{display:flex;justify-content:space-between;align-items:center;padding:10px 4px}
h1{margin:0;font-size:20px}
.tab{padding:10px 14px;border-radius:16px;border:1px solid var(--line);background:transparent;color:var(--ink)}
.tab.active{background:var(--btn);border-color:transparent}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:18px;padding:14px;margin-bottom:12px
}
label{font-size:12px;color:var(--muted);margin:14px 0 8px;display:block}
input,textarea{
  width:100%;padding:14px;border-radius:16px;
  border:1px solid var(--line);background:#0f0f16;color:var(--ink);font-size:17px
}
textarea{min-height:80px}
.stack{display:flex;flex-direction:column;gap:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
button{
  padding:12px 14px;border-radius:16px;
  border:1px solid var(--line);background:var(--btn);color:var(--ink)
}
button:disabled{
  opacity:.55;
}
.primary{background:var(--acc);border-color:transparent;color:#001427;font-weight:800}
.danger{background:transparent;border-color:var(--bad);color:var(--bad)}
.actions{display:flex;flex-direction:column;gap:12px;margin-top:12px}
.toast{
  position:fixed;left:50%;transform:translateX(-50%);
  bottom:calc(env(safe-area-inset-bottom)+16px);
  background:#0f0f16;border:1px solid var(--line);
  padding:10px 14px;border-radius:999px;font-size:13px;
  opacity:0;transition:.2s
}
.toast.show{opacity:1}
.items{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.item{border:1px solid var(--line);border-radius:16px;padding:12px;background:#0f0f16;white-space:pre-wrap}
.small{font-size:12px;color:var(--muted)}

/* ④ 保存成功フラッシュ */
.flash-ok{
  animation: okFlash 220ms ease-out;
}
@keyframes okFlash{
  0%   { box-shadow: 0 0 0 0 rgba(77,163,255,.0); transform: translateY(0); }
  20%  { box-shadow: 0 0 0 3px rgba(77,163,255,.35); }
  100% { box-shadow: 0 0 0 0 rgba(77,163,255,.0); transform: translateY(0); }
}
</style>
</head>

<body>
<header>
  <h1>スロ速メモ</h1>
  <div>
    <button id="tabAdd" class="tab active" type="button">追加</button>
    <button id="tabList" class="tab" type="button">履歴</button>
  </div>
</header>

<section id="add" class="card">
  <div class="stack">
    <div>
      <label>日付</label>
      <div class="row">
        <button id="today" type="button">今日</button>
        <button id="yesterday" type="button">昨日</button>
      </div>
      <input id="date" type="date" />
    </div>

    <div>
      <label>台番</label>
      <div class="row">
        <button id="daiMinus" type="button">-1</button>
        <button id="daiPlus" type="button">+1</button>
      </div>
      <input id="dai" inputmode="numeric" pattern="[0-9]*" />
    </div>

    <div>
      <label>当該ゲーム数（G）</label>
      <input id="games" inputmode="numeric" pattern="[0-9]*" />
    </div>

    <div>
      <label>スルー回数</label>
      <div class="row">
        <button id="suruMinus" type="button">-1</button>
        <button id="suruPlus" type="button">+1</button>
        <button id="suruZero" type="button">0</button>
      </div>
      <input id="suru" inputmode="numeric" pattern="[0-9]*" />
    </div>

    <div>
      <label>メモ</label>
      <textarea id="memo"></textarea>
    </div>
  </div>

  <div class="actions">
    <button id="save" class="primary" type="button">保存（最速）</button>
    <button id="saveNext" type="button">保存して次（台番+1）</button>
    <button id="reset" class="danger" type="button">入力リセット</button>
  </div>
</section>

<section id="list" class="card" style="display:none">
  <button id="copy" type="button">表示中をコピー</button>
  <div class="small">※ そのままLINEやメモに貼れます</div>
  <div id="items" class="items"></div>
</section>

<div id="toast" class="toast"></div>

<script>
(() => {
  "use strict";

  const LS = "slo_memo_v3";
  const $ = (id) => document.getElementById(id);

  const addSec = $("add");
  const listSec = $("list");
  const tabAdd = $("tabAdd");
  const tabList = $("tabList");
  const toast = $("toast");

  const dateEl = $("date");
  const daiEl = $("dai");
  const gamesEl = $("games");
  const suruEl = $("suru");
  const memoEl = $("memo");
  const itemsEl = $("items");

  const saveBtn = $("save");
  const saveNextBtn = $("saveNext");

  const buzz = (ms=20) => { try { if (navigator.vibrate) navigator.vibrate(ms); } catch {} };
  const show = (t) => {
    toast.textContent = t;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1200);
  };

  // ④ 保存成功フラッシュ
  const flashOK = () => {
    addSec.classList.remove("flash-ok");
    // reflow
    void addSec.offsetWidth;
    addSec.classList.add("flash-ok");
    setTimeout(()=>addSec.classList.remove("flash-ok"), 260);
  };

  // ローカル日付
  const isoLocal = (d=new Date()) => {
    const x = new Date(d);
    x.setMinutes(x.getMinutes() - x.getTimezoneOffset());
    return x.toISOString().slice(0,10);
  };
  const today = () => isoLocal(new Date());
  const yesterday = () => {
    const d = new Date();
    d.setDate(d.getDate() - 1);
    return isoLocal(d);
  };

  const load = () => {
    try {
      const raw = localStorage.getItem(LS);
      return raw ? JSON.parse(raw) : [];
    } catch {
      return [];
    }
  };

  const saveAll = (arr) => {
    try {
      localStorage.setItem(LS, JSON.stringify(arr));
      return true;
    } catch {
      show("保存できない");
      return false;
    }
  };

  const toNum = (v) => {
    const s = String(v ?? "").replace(/[, ]/g,"");
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  };

  const render = () => {
    itemsEl.innerHTML = "";
    const data = load();
    if (!data.length) {
      const e = document.createElement("div");
      e.className = "small";
      e.style.marginTop = "10px";
      e.textContent = "データがありません。";
      itemsEl.appendChild(e);
      return;
    }
    data.forEach(r => {
      const el = document.createElement("div");
      el.className = "item";
      el.textContent =
        `${r.date} 台${r.dai} ${r.games}G スルー${r.suru}` +
        (r.memo ? " " + r.memo : "");
      itemsEl.appendChild(el);
    });
  };

  tabAdd.onclick = () => {
    addSec.style.display = "";
    listSec.style.display = "none";
    tabAdd.classList.add("active");
    tabList.classList.remove("active");
  };
  tabList.onclick = () => {
    render();
    addSec.style.display = "none";
    listSec.style.display = "";
    tabList.classList.add("active");
    tabAdd.classList.remove("active");
  };

  $("today").onclick = () => dateEl.value = today();
  $("yesterday").onclick = () => dateEl.value = yesterday();

  $("daiMinus").onclick = () => {
    const n = toNum(daiEl.value);
    if(n===null) return;
    daiEl.value = n - 1;
    buzz(10);
  };
  $("daiPlus").onclick = () => {
    const n = toNum(daiEl.value);
    if(n===null) return;
    daiEl.value = n + 1;
    buzz(10);
  };

  $("suruMinus").onclick = () => {
    const n = toNum(suruEl.value) ?? 0;
    suruEl.value = Math.max(0, n - 1);
    buzz(10);
  };
  $("suruPlus").onclick = () => {
    const n = toNum(suruEl.value) ?? 0;
    suruEl.value = n + 1;
    buzz(10);
  };
  $("suruZero").onclick = () => {
    suruEl.value = 0;
    buzz(10);
  };

  // ⑥ 連打ガード（2重保存防止）
  let savingLock = false;
  const lockButtons = (ms=650) => {
    savingLock = true;
    saveBtn.disabled = true;
    saveNextBtn.disabled = true;
    setTimeout(() => {
      savingLock = false;
      saveBtn.disabled = false;
      saveNextBtn.disabled = false;
    }, ms);
  };

  saveBtn.onclick = () => save(false);
  saveNextBtn.onclick = () => save(true);

  function save(next){
    if (savingLock) return; // ⑥
    lockButtons(650);       // ⑥

    const dai = toNum(daiEl.value);
    const games = toNum(gamesEl.value);
    const suru = toNum(suruEl.value) ?? 0;

    if(dai===null || games===null){
      show("未入力あり");
      buzz(25);
      return;
    }

    const r = {
      date: dateEl.value || yesterday(),
      dai, games, suru,
      memo: memoEl.value.trim()
    };

    const d = load();
    d.unshift(r);
    if(!saveAll(d)) return;

    // ④ 保存成功のフィードバック
    flashOK();
    buzz(20);
    show("保存した");

    gamesEl.value = "";
    suruEl.value = "";
    memoEl.value = "";

    if(next) daiEl.value = dai + 1;
    daiEl.focus();
  }

  $("reset").onclick = () => {
    gamesEl.value = "";
    suruEl.value = "";
    memoEl.value = "";
    show("リセット");
    buzz(15);
  };

  $("copy").onclick = async () => {
    const text = load().map(r =>
      `${r.date} 台${r.dai} ${r.games}G スルー${r.suru}${r.memo ? " " + r.memo : ""}`
    ).join("\n");
    try{
      await navigator.clipboard.writeText(text);
      show("コピーした");
      buzz(20);
    }catch{
      alert(text);
    }
  };

  dateEl.value = yesterday();
  setTimeout(()=>daiEl.focus(),200);
})();
</script>
</body>
</html>
